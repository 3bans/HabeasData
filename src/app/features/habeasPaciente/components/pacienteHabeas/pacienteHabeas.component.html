<app-navbar></app-navbar>
<app-modal [(visible)]="showModalHabeas" headerTitle="C√≥digo de verificaci√≥n" [showFooter]="false"
  (cancel)="closeModal()" [dialogStyle]="{ width: '300px', height: 'auto', 'z-index': '1100' }">
  <div modal-body>
    <form [formGroup]="formHabeas" class="p-fluid">
      <app-input  formControlName="codigo" label="C√≥digo de verificaci√≥n" placeholder="C√≥digo de verificaci√≥n"
        icon="pi pi-id-card"></app-input>
      <div *ngIf="mensajeCodigo" class="text-danger mt-2">
        {{ mensajeCodigo }}
      </div>
      <button pButton type="button" label="Validar c√≥digo" class="mt-3" (click)="validarCodigo()"></button>
    </form>
  </div>
</app-modal>
<app-modal
 [(visible)]="showModal" headerTitle="Motivo de no autorizaci√≥n " class="mb-6 block"
  [dialogStyle]="{ width: '1000px', height: '600px' }" (accept)="registerHabeas('N')" (cancel)="closeModal()" [acceptDisabled]="!habilitarAceptar"
>
  <div modal-body class="p-fluid">
    <label class="mb-4 block">Por favor seleccione al m√©dico con el que no aceptan el habeas data:</label>
    <app-list-select-loader    #medicoNoSelectRef
 [url]="urlCargarLista" [optionLabel]="'nombreMedico'" [optionValue]="'noIdentificacion'"
      [emitLabel]="false" (selectedChange)="onSeleccion($event, 'medico')" class="mb-4 block"></app-list-select-loader>
    <label for="motivo" class="mb-4 block">Expl√≠quenos por qu√© no autoriza:</label>
    <app-list-select-loader      #motivoSelectRef
     [url]="urlMotivosHabeas" [optionLabel]="'descripcion'" [optionValue]="'id_motivo'"
      [emitLabel]="false" (selectedChange)="onSeleccion($event,'motivo')" class="mb-4 block"></app-list-select-loader>
  </div>
</app-modal>

<app-modal [(visible)]="showModalRegistro" headerTitle="Autorizaci√≥n de habeas data " class="mb-6 block"
  [dialogStyle]="{ width: '1000px', height: '600px' }" (accept)=" enviarSms('P')" (cancel)="closeModal()" [acceptDisabled]="! habilitarAceptarRegistro">
  <div modal-body class="p-fluid">
    <label class="mb-4 block">Por favor seleccione al m√©dico para firmar el habeas data:</label>
    <app-list-select-loader   medicoNoSelectRef
 [url]="urlCargarLista" [optionLabel]="'nombreMedico'" [optionValue]="'noIdentificacion'"
      [emitLabel]="false" (selectedChange)="onSeleccion($event, 'medico')" class="mb-4 block"></app-list-select-loader>
    <label for="motivo" class="mb-4 block">Medio de autorizaci√≥n:</label>
    <p-select [options]="TipoHabeas" optionLabel="label" placeholder="Seleccione" class="w-full pi-id-card"
      optionValue="value"     (onChange)="onSeleccionMedio($event.value)"/>
  </div>
</app-modal>
<div class="flex justify-content-center surface-50 py-6 px-4">
  <div class="surface-card p-5 shadow-3 border-round-xl w-full" style="max-width: 1200px;">

    <h2 class="text-2xl font-semibold mb-5 border-bottom-1 surface-border pb-3">
      Registro Habeas Data
    </h2>

    <!-- FORMULARIO -->
    <form [formGroup]="formHabeas" (ngSubmit)="onSubmit()" class="grid formgrid p-fluid">

      <!-- Tipo de documento alineado con inputs -->
      <div class="field col-12 md:col-6">
        <label for="tipoDocumento">Tipo de documento</label>
        <p-select formControlName="tipoDocumento" [options]="tipoDocumentoOptions" optionLabel="label"
          placeholder="Seleccione" class="w-full pi-id-card" optionValue="value" />
      </div>

      <div class="field col-12 md:col-6">
        <app-input formControlName="identificadorUnico" label="N√∫mero de identificaci√≥n"
          placeholder="N√∫mero de identificaci√≥n" icon="pi pi-id-card"></app-input>
      </div>
      <div class="field col-12 md:col-6">
        <app-input formControlName="identificacion" label="Identificador √∫nico" placeholder="Identificador √∫nico"
          icon="pi pi-id-card"></app-input>
      </div>

      <div class="field col-12 md:col-6">
        <app-input formControlName="nombresPaciente" label="Nombres Paciente" placeholder="Nombres paciente"
          icon="pi pi-user"></app-input>
      </div>
      <div class="field col-12 md:col-6">
        <app-input formControlName="primerApellido" label="Primer Apellido" placeholder="Primer apellido"
          icon="pi pi-user"></app-input>
      </div>
      <div class="field col-12 md:col-6">
        <app-input formControlName="segundoApellido" label="Segundo Apellido" placeholder="Segundo apellido"
          icon="pi pi-user"></app-input>
      </div>
      <div class="field col-12 md:col-6">
        <app-input formControlName="celular" label="N√∫mero celular" placeholder="N√∫mero celular"
          icon="pi pi-mobile"></app-input>
      </div>
      <div class="field col-12 md:col-6">
        <app-input formControlName="fechaNacimiento" label="Fecha de nacimiento" placeholder="Fecha de nacimiento"
          icon="pi pi-calendar"></app-input>
      </div>
      <div class="field col-12 md:col-6">
        <app-input formControlName="correoElectronico" label="Correo Electr√≥nico" placeholder="Correo electr√≥nico"
          icon="pi pi-envelope"></app-input>
      </div>
      <div class="field col-12 md:col-6">
        <label for="autorizacionHabeas">Autorizaci√≥n habeas</label>
        <p-select formControlName="autorizacionHabeas" (onChange)="onAutorizacionChange($event.value)"
          [options]="RespuestaHabeas" optionLabel="label" placeholder="Seleccione" class="w-full pi-id-card" />
      </div>
    </form>

    <div *ngIf="estadosHabeas.length > 0">
      <div *ngFor="let estado of estadosHabeas" [ngClass]="{
    'estado-box': true,
    'estado-pendiente': estado.tipo === 'P',
    'estado-aceptado': estado.tipo === 'S',
    'estado-rechazado': estado.tipo === 'N'
  }">
        <ng-container [ngSwitch]="estado.tipo">

          <!-- Pendiente -->
          <ng-container *ngSwitchCase="'P'">
            <div>üìå <strong>Habeas Data pendiente:</strong></div>
            <div>üïí Registro pendiente con el m√©dico: <span class="nombre-medico">{{ estado.medico }}</span></div>
            <div><strong>Fecha:</strong> {{ estado.fecha }}</div>

            <!-- ‚úÖ Bot√≥n solo si hay c√≥digo -->
            <div *ngIf="estado.codigo">
              <button class="p-button p-button-warning mt-2" (click)="enviarCodigos(estado.codigo)">
                üîÅ Reenviar C√≥digo
              </button>
            </div>
          </ng-container>

          <!-- Aceptado -->
          <ng-container *ngSwitchCase="'S'">
            <div>‚úÖ <strong>Habeas Data aceptado:</strong></div>
            <div>üë®‚Äç‚öïÔ∏è Aceptado con el m√©dico: <span class="nombre-medico">{{ estado.medico }}</span></div>
            <div><strong>Fecha:</strong> {{ estado.fecha }}</div>
          </ng-container>

          <!-- No aceptado -->
          <ng-container *ngSwitchCase="'N'">
            <div>üî¥ <strong>Habeas Data NO aceptado:</strong></div>
            <div>‚ùå No aceptado con el m√©dico: <span class="nombre-medico">{{ estado.medico }}</span></div>
            <div><strong>Motivo:</strong> {{ estado.motivo }}</div>
            <div><strong>Fecha:</strong> {{ estado.fecha }}</div>
          </ng-container>
        </ng-container>
      </div>
    </div>

    <div *ngIf="mensajeErrorHabeas" class="banner-error">
      <i class="pi pi-times-circle icon-error"></i>
      <span class="texto-error">{{ mensajeErrorHabeas }}</span>
    </div>
    <div *ngIf="mensajeEstadoHabeas" class="banner-info">
      <i class="pi pi-info-circle icon-info"></i>
      <span class="texto-info">{{ mensajeEstadoHabeas }}</span>
    </div>

    <div class="flex justify-content-end gap-3 mt-6 pt-4 border-top-1 surface-border">
      <button pButton type="button" label="Limpiar" class="p-button-outlined p-button-secondary w-8rem"
        (click)="onReset()"></button>
      <button pButton type="submit" label="Registrar" class="p-button-primary w-8rem" [disabled]="!registroHabilitado"
        (click)="openModalRegistrar()"></button>
    </div>

  </div>
</div>
